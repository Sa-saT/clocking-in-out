# アプリ完成イメージ・要件

## 開発フロー（タスク追加・仕様変更時の手順）
1. 追加で必要なタスクや仕様の説明を行う
2. OKならAPP_SPECに未記載の説明やTASKを必ず追記する
3. APP_SPECへの追記後、実装などの作業に着手する

## 目的
- 従業員の出退勤をWebで管理する

## 主要機能
- ユーザー登録・ログイン
- 出勤・退勤の打刻
- 打刻履歴の閲覧
- 管理者によるユーザー管理・履歴修正
- レスポンシブ対応

## 技術構成
- Nuxt3
- Prisma
- PostgreSQL
- Pinia
- Tailwind CSS

## DB設計
- **User**: ユーザー情報（id, email, password, name）
- **Clock**: 出退勤打刻情報（id, userId, clockIn: 出勤時刻, clockOut: 退勤時刻, createdAt）
  - UserとClockは1対多リレーション

## 認証設計方針
- `stores/auth.ts`：認証状態・ユーザー情報のPiniaストア管理（isAuthenticated, user, login/logoutアクション等）
- `composables/useAuth.ts`等：認証API呼び出し・認証ロジックの共通化
- `server/api/auth/`：Prismaを用いたDB認証・ユーザー作成・パスワードハッシュ化等のサーバー処理
- `middleware/auth.global.ts`等：ルートガードや認証必須ページの制御
- ログイン時は「email」「password」のみ入力。nameは不要。
- 使用者は基本「一般ユーザ」のみを想定。
- ログアウトUIは`Layouts/default.vue`で作成予定。

---

## TASK（進行タスク一覧）

- [x] 1. APP_SPEC.md作成・運用方針決定
- [x] 2. ログイン画面作成
    - [x] 2-1. stores/auth.ts（認証ストア）
    - [x] 2-2. composables/useAuth.ts（API呼び出し・認証ロジック）
    - [x] 2-3. server/api/auth/login.post.ts（DB認証API）
    - [x] 2-4. pages/login.vue（UI実装）
- [x] lib/prisma.ts導入・API全体での共通利用設計（server/配下も含む）
- [x] 3. 打刻API実装
    - [x] 3-1. 打刻履歴取得API実装（server/api/clock/history.get.ts）
    - [x] 3-2. 履歴取得APIの認証・バリデーション強化
    - [x] 3-3. 履歴取得APIのページング・日付フィルタ設計（将来的拡張）
    - [x] 3-4. クライアント側一時ストレージのSessionStorage利用方針反映
    - [x] 3-5. JWT認証方式の導入検討・設計
- [x] 4. 打刻履歴画面作成
- [x] 5. 管理者画面設計
  - [x] 5-1. 管理者用ダッシュボード画面の設計・実装
  - [x] 5-2. ユーザー一覧表示機能の実装
  - [x] 5-3. 打刻履歴の修正・削除機能の設計・実装
  - [x] 5-4-1. 管理者認可ロジックの共通化（requireAdminの導入）
  - [x] 5-4-2. 既存APIへのrequireAdmin適用・認可強化
  - [x] 5-4-3. フロント側の認可ガード強化
- [x] 6. UIデザイン調整
  - [x] 6-1. レイアウト分離（Header/Footerコンポーネント化・default.vue作成）
  - [x] 6-2. middleware分離（admin-only.ts作成）
  - [x] 6-3. UIブラッシュアップ（Tailwind CSSによるデザイン改善・アクセシビリティ対応等）
  - [x] 6-4. リロード時や初回アクセス時にSessionStorageから認証情報を復元する処理の実装
  - [x] 6-5. 再利用可能な関数の最適化
    - [x] 6-5-1. データフェッチング統一（useFetch、useAsyncData、$fetchの使い分けルール策定・実装）
    - [x] 6-5-2. エラーハンドリング共通化（useError、useToast等のcomposable作成）
    - [x] 6-5-3. JWT認証共通化（$authFetchの全API適用、requireAuth/requireAdminの統一）
    - [x] 6-5-4. プラグイン機能導入（グローバル設定、共通処理のプラグイン化）
  - [x] 6-6. 起動テスト（Admin/Userでのログイン・主要画面遷移・API疎通確認）
  - [x] 6-7. UIの細かい仕様
  - [x] 6-8. 退勤打刻漏れ自動補完仕様
  - [x] 6-9. Login画面で星空背景をThree.jsで演出
- [ ] 7. レスポンシブ対応
- [ ] 8. Admin Headerメニュー（ハンバーガー⇨X切替、User表示・選択、打刻月一覧、月選択、x月一覧表示）
- [ ] 9. Adminのみ "月選択"データ出力機能（PDFエクスポート）

---

## 進捗・メモ

**2024年12月26日 実装完了**
- 認証基盤完成：`stores/auth.ts`、`composables/useAuth.ts`、`server/api/auth/login.post.ts`、`pages/login.vue`
- ダッシュボード画面作成：`pages/dashboard.vue`（出退勤打刻UI、仮実装）
- ルーティング設定：`pages/index.vue`（認証状態に応じたリダイレクト）
- Prisma設定完了：Userモデルにnameフィールド追加、マイグレーション・型生成完了
- `lib/prisma.ts`追加：PrismaClientのシングルトン化（グローバルインスタンス化）で開発時の多重生成・DB接続数増加を防止。APIごとにPrismaClientをnewするのではなく、lib/prisma.ts経由で共通インスタンスを利用する設計に統一。
    - server/配下のAPI実装も全てlib/prisma.ts経由でPrismaClientを利用する方針に変更。

**2024年6月30日 追加タスク・仕様・方針**
- 打刻履歴取得API（server/api/clock/history.get.ts）を新規作成し、指定ユーザーの打刻履歴（Clockレコード一覧）を返す。
- 履歴取得APIでは認証済みユーザーのみが自身の履歴を取得できるようにサーバー側で検証を行う。
- 今後の拡張性を考慮し、ページングや日付フィルタ用のパラメータも設計に含める（初期実装は全件返却）。
- APIのエラーハンドリング・バリデーションも強化する。
- 一時的なクライアントストレージにはSessionStorageを利用する方針。
- 認証トークンの暗号化・管理にはJWT（JSON Web Token）を採用する方針を検討中。

**2024年7月1日 TASK追加・仕様**
- 履歴取得API（/api/clock/history）は現状userIdクエリのみで認証チェックがないため、セキュリティ強化として「認証済みユーザーのみが自身の履歴だけ取得できる」ようにする。
- JWT認証導入を見据え、現段階では仮の認証（例：セッションやストアのユーザーIDと照合）で実装し、将来的にJWT認証へスムーズに移行できる構成とする。

**2024年7月1日 TASK追加・仕様（ページング・日付フィルタ）**
- 履歴取得API（/api/clock/history）で、今後のパフォーマンス・UX向上のためページング（limit, offset, page等）や日付範囲フィルタ（dateFrom, dateTo等）のクエリパラメータを受け取れる設計に拡張する。
- Prismaのwhere句・skip/takeで対応し、将来的な大量データにも耐えられるAPI設計とする。

**2024年7月1日 TASK追加・仕様（SessionStorage連携）**
- クライアント側で一時的に保持するデータ（例：認証トークンやユーザー情報）は、セキュリティ・利便性の観点からSessionStorageを利用する方針。
- Piniaストア（authStore）で管理しているユーザー情報を、ログイン時にSessionStorageへ保存し、アプリ起動時にSessionStorageから復元する仕組みを追加する。
- これにより、リロードやタブの再読み込みでも認証状態を維持できるようにする。

**2024年7月1日 TASK追加・仕様（JWT認証導入）**
- セキュリティ・スケーラビリティ・API保護の観点からJWT（JSON Web Token）認証方式を導入する。
- ログイン時にサーバーがJWTを発行し、クライアントはこのトークンを保持。以降のAPIリクエスト時にAuthorization: Bearer <token>ヘッダーで送信する。
- サーバー側はJWTを検証し、ユーザー認証・認可を行う。
- まずは「ログイン時にJWT発行→クライアントで保持→APIリクエスト時に送信→サーバーで検証」の基本フローを設計・実装する。

3系TASK（履歴APIの認証・バリデーション強化、ページング・日付フィルタ、SessionStorage連携、JWT認証導入）は全て完了。
次は「5. 管理者画面設計」に進む。

**2024年7月2日 TASK追加・仕様（管理者画面設計）**
- 管理者は「role:admin」を持つユーザーとし、一般ユーザーとは別のダッシュボード・機能を持つ。
- 管理者は全ユーザーの一覧・編集、打刻履歴の修正・削除が可能。
- 管理者用API・画面はJWT認証＋role:admin認可で保護する。
- サブタスクとしてダッシュボード、ユーザー管理、履歴修正、認可強化などを段階的に実装する。

**2024年7月2日 TASK追加・仕様（ユーザー一覧・編集機能）**
- 管理者は全ユーザーの一覧を閲覧・編集できる。
- 編集内容は「ユーザー名・メールアドレス・role（admin/一般）」など。パスワード変更は別途設計。
- APIはJWT認証＋role:admin認可必須。
- UIはTailwind CSSでシンプルに、編集はモーダルまたはインライン編集で実装予定。

**2024年7月2日 TASK追加・仕様（打刻履歴の修正・削除機能）**

### 概要
管理者は任意ユーザーの打刻履歴（Clockレコード）を修正・削除できる。編集・削除UIは履歴一覧テーブル上でモーダルまたはインラインで実装。

### 編集・削除対象
- 出勤時刻（clockIn）
- 退勤時刻（clockOut）
- レコード自体の削除

### バリデーション
- clockIn/clockOut：日付・時刻形式、clockIn < clockOut
- 削除は確認ダイアログ必須

### API仕様
- 編集：`PATCH /api/admin/clocks/[id]`
- 削除：`DELETE /api/admin/clocks/[id]`
- 認証：JWT必須
- 認可：管理者のみ（admin@example.comで判定）
- リクエストbody例（編集）：
  ```json
  {
    "clockIn": "2024-07-01T09:00:00Z",
    "clockOut": "2024-07-01T18:00:00Z"
  }
  ```
- レスポンス例：
  ```json
  {
    "success": true,
    "clock": { "id": 1, "clockIn": "...", "clockOut": "..." }
  }
  ```
- エラー時は400/401/403/422等で詳細メッセージ返却

### UI方針
- 履歴一覧テーブルの各行に「編集」「削除」ボタンを設置
- 編集ボタン押下でモーダルまたはインライン編集フォーム表示
- 削除ボタン押下で確認ダイアログ表示→OKでAPIリクエスト
- 編集・削除後は即時反映、失敗時はエラーメッセージ表示
- 編集中・削除中は他の操作をロック
- 編集・削除キャンセル可

### その他
- 監査ログや復元機能は現状未対応

【ルール】
・TASKの完了時は必ず[x]チェックすること。
・追加TASKや仕様変更は必ずAPP_SPEC.mdに追記・明記すること。

---

> **注意**
> 本プロジェクトは常にAPP_SPEC.mdの内容を基準として開発・認識合わせを行います。
> タスク追加・完了・仕様変更は必ずこのファイルに反映してください。

---

## 5-2. ユーザー編集機能 設計・仕様

### 概要
管理者はユーザー一覧から各ユーザーの「名前」「メールアドレス」を編集できる。編集UIはインライン編集またはモーダルで実装。編集内容は即時APIで反映。

### 編集対象
- 名前（name）
- メールアドレス（email）
  - ※roleは将来的拡張時に対応

### バリデーション
- 名前：空欄不可、最大50文字
- メールアドレス：空欄不可、メール形式、最大100文字

### API仕様
- エンドポイント：`PATCH /api/admin/users/[id]`
- 認証：JWT必須
- 認可：管理者のみ（現状はadmin@example.comで判定）
- リクエストbody例：
  ```json
  {
    "name": "新しい名前",
    "email": "new@example.com"
  }
  ```
- レスポンス例：
  ```json
  {
    "success": true,
    "user": { "id": 1, "name": "新しい名前", "email": "new@example.com" }
  }
  ```
- エラー時は400/401/403/422等で詳細メッセージ返却

### UI方針
- ユーザー一覧テーブルの各行に「編集」ボタンを設置
- 編集ボタン押下でモーダルまたはインライン編集フォーム表示
- 編集内容を入力し「保存」→APIリクエスト→成功時は即時反映、失敗時はエラーメッセージ表示
- 編集中は他の操作をロック
- 編集キャンセル可

### その他
- 編集APIは今後role追加時にも拡張しやすい設計とする
- 変更履歴や監査ログは現状未対応

## 5-4. 管理者認可（role:admin）によるAPI・画面保護 設計・方針

### 概要
管理者用API・画面は「管理者（role:admin）」のみアクセス可能とする。現状はUserモデルにroleフィールドが無いため、admin@example.comで暫定判定。将来的にはDBにroleフィールドを追加し、柔軟な認可制御に拡張予定。

### サーバー側（API）
- 管理者認可ロジックを共通化（例：`requireAdmin(event)` composable/middleware化）
- すべての管理者用APIでrequireAdminを利用し、認可漏れを防止
- 現状はpayload.email === 'admin@example.com'で判定。role追加時はpayload.role === 'admin'で判定に切替。

### クライアント側（画面）
- 管理者画面・機能へのアクセスはPiniaストアのユーザー情報で判定
- 現状はuser.email === 'admin@example.com'でガード。role追加時はuser.role === 'admin'で判定に切替。
- 認可エラー時はログイン画面または権限エラー画面にリダイレクト

### 今後の拡張方針
- Userモデルにroleフィールド（例：'user'|'admin'）を追加し、認可ロジックをroleベースに移行
- role追加時は既存API・画面の認可判定を一括で切替
- 管理者権限の柔軟な拡張（例：複数管理者、権限レベル追加等）も見据える

### 備考
- 現状のadmin@example.com判定は暫定措置であり、roleフィールド追加後は速やかに移行する

## 6. UIデザイン調整 設計・方針

### 概要
アプリ全体のUI/UXを向上させるため、レイアウト・コンポーネント・ミドルウェアを分離し、再利用性・保守性を高める。今後はTailwind CSSによるデザイン改善やアクセシビリティ対応も段階的に実施。

### サブタスク
- 6-1. レイアウト分離：Header/Footerをcomponents配下に分離し、layouts/default.vueで共通化
- 6-2. middleware分離：管理者専用ページ用のadmin-only.tsをmiddleware配下に新規作成
- 6-3. UIブラッシュアップ：Tailwind CSSによるデザイン改善、アクセシビリティ・レスポンシブ対応、ダークモード対応等

### 今後の方針
- 各ページ・機能で共通レイアウト・コンポーネント・ミドルウェアを適用し、UI/UXの一貫性を担保
- ユーザビリティ・アクセシビリティ向上のための改善を継続的に実施 

## 開発・テスト用アカウント

- 管理者（Admin）
  - email: admin@example.com
  - password: adminpass

- 一般ユーザー（User）
  - email: user1@example.com
  - password: userpass1 

## 6-6. 起動テスト手順

### 管理者（Admin）でのテスト
1. ログイン画面で「admin@example.com」「adminpass」でログイン
2. 管理者ダッシュボードに遷移すること
3. ユーザー一覧・編集・履歴修正が正常に動作すること
4. JWT認証・認可ガードで不正アクセスが拒否されること
5. ログイン動作が正常であること（認証失敗時のエラー表示含む）
6. 打刻履歴の表示・取得が正常に行えること（履歴が表示されない場合は実装・API・UIを修正する）
7. 出勤・退勤ボタン押下でAPIが呼ばれ、履歴が即時反映されること（不具合時は実装・API・UIを修正する）

### 一般ユーザー（User）でのテスト
1. ログイン画面で「user1@example.com」「userpass1」でログイン
2. 一般ダッシュボードに遷移すること
3. 出退勤打刻・履歴取得が正常に動作すること
4. 管理者画面へのアクセスが拒否されること
5. ログイン動作が正常であること（認証失敗時のエラー表示含む）
6. 打刻履歴の表示・取得が正常に行えること（履歴が表示されない場合は実装・API・UIを修正する）
7. 出勤・退勤ボタン押下でAPIが呼ばれ、履歴が即時反映されること（不具合時は実装・API・UIを修正する）

### 共通
- リロード・タブ再読み込み時に認証状態が維持されること
- ログアウト後はログイン画面に遷移し、再認証が必要なこと
- UIアクセシビリティ（フォーカス、aria属性、ダークモード等）が担保されていること
- 上記テスト観点で不具合が発生した場合は、必ず実装・API・UIの修正を行い、APP_SPEC.mdのTASK・進捗に反映すること 

## 6-8. 退勤打刻漏れ自動補完仕様

- 日付が変わった時点で、前日までの未退勤レコード（clockOut: null）が存在する場合、自動でclockOutに「23:59:59」をセットし、noteに「打刻漏れ」と記録する。
- これにより、翌日以降も新たに出勤打刻が可能となり、履歴にも「打刻漏れ」が明示される。
- DBスキーマにnote（String?）カラムを追加し、打刻漏れや備考を記録できるようにする。
- 自動補完処理は出勤API実行時やバッチ処理で行う。
- フロント履歴表示ではnoteが「打刻漏れ」の場合は強調表示する。 

## 6-9. Login画面で星空背景をThree.jsで演出

- ログイン画面でThree.jsによる星空背景を表示し、インタラクティブな体験を提供する。
- モデル演出は廃止し、星空のみのシンプルな演出とした。
- 星空はマウスポインタ連動で動き、UIの奥に配置される。
- パフォーマンス・アクセシビリティ・リソース管理も最適化。
